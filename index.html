<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Mini Shooter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
/* ===== FIREBASE MODERN SDK ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1FhFMFEFChjENC3gp8fPM-06jKSN86w",
  authDomain: "minishooter.firebaseapp.com",
  databaseURL: "https://minishooter-default-rtdb.firebaseio.com",
  projectId: "minishooter",
  storageBucket: "minishooter.appspot.com",
  messagingSenderId: "363773533175",
  appId: "1:363773533175:web:d41377d66730ff7ca2ecf2"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

let user = null;

/* ===== AUTH ===== */
window.login = () => {
  signInWithPopup(auth, provider).catch(e => alert(e.message));
};

onAuthStateChanged(auth, u => {
  user = u;
  document.getElementById("playerName").textContent =
    u ? "P콏ihl치코en: " + u.displayName : "Nep콏ihl치코en";
});

/* ===== LEADERBOARD ===== */
const leaderboardEl = document.getElementById("leaderboard");

function saveScore(score) {
  if (!user) return;
  const r = ref(db, "leaderboard/" + user.uid);
  get(r).then(snap => {
    if (!snap.exists() || score > snap.val().score) {
      set(r, { name: user.displayName, score });
    }
  });
}

onValue(ref(db, "leaderboard"), snap => {
  leaderboardEl.innerHTML = "";
  if (!snap.exists()) return;
  Object.values(snap.val())
    .sort((a,b)=>b.score-a.score)
    .slice(0,10)
    .forEach((p,i)=>{
      leaderboardEl.innerHTML += `<tr><td>${i+1}. ${p.name} (${p.score})</td></tr>`;
    });
});

/* ===== GAME ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const scoreEl = document.getElementById("score");

let score = 0, lives = 20, over = false;
const player = { x:180, y:520, s:8 };
let bullets=[], enemies=[], keys={}, t=0;

document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

canvas.addEventListener("mousedown",()=>{
  over ? restart() : bullets.push({x:player.x+18,y:player.y});
});

function restart(){
  score=0; lives=20; over=false;
  bullets=[]; enemies=[];
  scoreEl.textContent=0;
}

function spawn(){ enemies.push({x:Math.random()*360,y:-40}); }

function update(){
  if(over) return;
  if(keys.a&&player.x>0) player.x-=player.s;
  if(keys.d&&player.x<360) player.x+=player.s;

  bullets.forEach(b=>b.y-=10);
  bullets=bullets.filter(b=>b.y>-10);
  enemies.forEach(e=>e.y+=1);

  if(++t>180){spawn();t=0;}

  enemies.forEach((e,ei)=>{
    bullets.forEach((b,bi)=>{
      if(b.x<e.x+40&&b.x+4>e.x&&b.y<e.y+40&&b.y+10>e.y){
        enemies.splice(ei,1);
        bullets.splice(bi,1);
        score++; scoreEl.textContent=score;
      }
    });
    if(e.y>600){enemies.splice(ei,1);lives--;}
  });

  if(lives<=0){ over=true; saveScore(score); }
}

function draw(){
  ctx.clearRect(0,0,400,600);
  ctx.fillStyle="lime"; ctx.fillRect(player.x,player.y,40,40);
  ctx.fillStyle="yellow"; bullets.forEach(b=>ctx.fillRect(b.x,b.y,4,10));
  ctx.fillStyle="red"; enemies.forEach(e=>ctx.fillRect(e.x,e.y,40,40));
}

(function loop(){update();draw();requestAnimationFrame(loop);})();
</script>

<style>
body{background:#111;color:#fff;text-align:center;font-family:Arial}
canvas{background:#000;border:2px solid #fff}
</style>
</head>

<body>
<h1>游댦 Mini Shooter</h1>
<canvas id="game" width="400" height="600"></canvas>
<p>Sk칩re: <span id="score">0</span></p>

<button onclick="login()">P콏ihl치sit se Googlem</button>
<p id="playerName">Nep콏ihl치코en</p>
<table id="leaderboard"></table>
</body>
</html>
